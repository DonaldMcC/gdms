{{extend 'layout.html'}}
<script><!--
    jQuery(document).ready(function(){
    jQuery("table.sortable tbody tr").mouseover( function() {
    jQuery(this).addClass("highlight"); }).mouseout( function() {
    jQuery(this).removeClass("highlight"); });
    jQuery('table.sortable tbody tr:odd').addClass('odd');
    jQuery('table.sortable tbody tr:even').addClass('even');
});
//--></script>

{{if request.function=='index':}}
<h2>{{=T("Available Databases and Tables")}}</h2>
  {{if not databases:}}{{=T("No databases in this application")}}{{pass}}
  <ul class="nav nav-tabs" id="myTab">
  <li class="active" ><a href="#alltables" data-toggle="tab">Tables</a></li>
  <li><a href="#hooks" data-toggle="tab">Hooks</a></li>
  </ul>
  <div class="tab-content">
      <div class="tab-pane active" id="alltables">
        <table class="table">
          {{for db in sorted(databases):}}
            {{for table in databases[db].tables:}}
              {{qry='%s.%s.id>0'%(db,table)}}
              {{tbl=databases[db][table]}}
              {{if hasattr(tbl,'_primarykey'):}}
                {{if tbl._primarykey:}}
                    {{firstkey=tbl[tbl._primarykey[0]]}}
                    {{if firstkey.type in ['string','text']:}}
                      {{qry='%s.%s.%s!=""'%(db,table,firstkey.name)}}
                    {{else:}}
                      {{qry='%s.%s.%s>0'%(db,table,firstkey.name)}}
                    {{pass}}
                {{else:}}
                     {{qry=''}}
                {{pass}}
              {{pass}}
          <tr>
            <th style="font-size: 1.75em;">
              {{=A("%s.%s" % (db,table),_href=URL('select',args=[db],vars=dict(query=qry)))}}
            </th>
            <td>
              {{=A(str(T('New Record')),_href=URL('insert',args=[db,table]),_class="btn btn-default")}}
            </td>
          </tr>
          {{pass}}
          {{pass}}
        </table>
      </div>
      <div class="tab-pane" id="hooks">
      {{=LOAD('appadmin', 'hooks', ajax=True)}}
      </div>
  </div>
{{elif request.function=='select':}}
  <h2>{{=XML(str(T("Database %s select"))%A(request.args[0],_href=URL('index'))) }}
  </h2>
  {{if tb:}}
  <h3>{{=T('Traceback')}}</h3>
  <pre>
    {{=tb}}
  </pre>
  {{pass}}
  {{if table:}}
  {{=A(str(T('New Record')),_href=URL('insert',args=[request.args[0],table]),_class="btn btn-default")}}<br/><br/>
    <h3>{{=T("Rows in Table")}}</h3><br/>
   {{else:}}
    <h3>{{=T("Rows selected")}}</h3><br/>
   {{pass}}
   {{=form}}
   <p>{{=T('The "query" is a condition like "db.table1.field1==\'value\'". Something like "db.table1.field1==db.table2.field2" results in a SQL JOIN.')}}<br/>
      {{=T('Use (...)&(...) for AND, (...)|(...) for OR, and ~(...)  for NOT to build more complex queries.')}}<br/>
      {{=T('"update" is an optional expression like "field1=\'newvalue\'". You cannot update or delete the results of a JOIN')}}</p>
    <br/><br/>
    <h4>{{=T("%s selected", nrows)}}</h4>
    {{if start>0:}}{{=A(T('previous %s rows') % step,_href=URL('select',args=request.args[0],vars=dict(start=start-step)),_class="btn btn-default")}}{{pass}}
    {{if stop<nrows:}}{{=A(T('next %s rows') % step,_href=URL('select',args=request.args[0],vars=dict(start=start+step)),_class="btn btn-default")}}{{pass}}
    {{if rows:}}
       <div style="overflow:auto; width:80%;">
       {{linkto = lambda f, t, r: URL('update', args=[request.args[0], r, f]) if f else "#"}}
       {{upload=URL('download',args=request.args[0])}}
       {{=SQLTABLE(rows,linkto,upload,orderby=True,_class='sortable')}}
       </div>
    {{pass}}
    <br/><br/><h3>{{=T("Import/Export")}}</h3><br/>
    <a href="{{=URL('csv',args=request.args[0],vars=dict(query=query))}}" class="btn btn-default">{{=T("export as csv file")}}</a>
  {{=formcsv or ''}}

{{elif request.function=='insert':}}
  <h2>{{=T("Database")}} {{=A(request.args[0],_href=URL('index'))}}
    {{if hasattr(table,'_primarykey'):}}
      {{fieldname=table._primarykey[0]}}
      {{dbname=request.args[0]}}
      {{tablename=request.args[1]}}
      {{cond = table[fieldname].type in ['string','text'] and '!=""' or '>0'}}
      {{=T("Table")}} {{=A(tablename,_href=URL('select',args=dbname,vars=dict(query='%s.%s.%s%s'%(dbname,tablename,fieldname,cond))))}}
    {{else:}}
      {{=T("Table")}} {{=A(request.args[1],_href=URL('select',args=request.args[0],vars=dict(query='%s.%s.id>0'%tuple(request.args[:2]))))}}
    {{pass}}
  </h2>
  <h3>{{=T("New Record")}}</h3><br/>
  {{=form}}
{{elif request.function=='update':}}
  <h2>{{=T("Database")}} {{=A(request.args[0],_href=URL('index'))}}
    {{if hasattr(table,'_primarykey'):}}
      {{fieldname=request.vars.keys()[0]}}
      {{dbname=request.args[0]}}
      {{tablename=request.args[1]}}
      {{cond = table[fieldname].type in ['string','text'] and '!=""' or '>0'}}
      {{=T("Table")}} {{=A(tablename,_href=URL('select',args=dbname,vars=dict(query='%s.%s.%s%s'%(dbname,tablename,fieldname,cond))))}}
      {{=T("Record")}} {{=A('%s=%s'%request.vars.items()[0],_href=URL('update',args=request.args[:2],vars=request.vars))}}
    {{else:}}
      {{=T("Table")}} {{=A(request.args[1],_href=URL('select',args=request.args[0],vars=dict(query='%s.%s.id>0'%tuple(request.args[:2]))))}}
      {{=T("Record id")}} {{=A(request.args[2],_href=URL('update',args=request.args[:3]))}}
    {{pass}}
  </h2>
  <h3>{{=T("Edit current record")}}</h3><br/><br/>{{=form}}

{{elif request.function=='state':}}
  <h2>{{=T("Internal State")}}</h2>
  <h3>{{=T("Current request")}}</h3>
  {{=BEAUTIFY(request)}}
  <br/><h3>{{=T("Current response")}}</h3>
  {{=BEAUTIFY(response)}}
  <br/><h3>{{=T("Current session")}}</h3>
  {{=BEAUTIFY(session)}}


{{elif request.function == 'ccache':}}
<h2>{{T("Cache")}}</h2>
<div class="list">

  <div class="list-header">
    <h3>{{T("Statistics")}}</h3>
  </div>

  <div class="content">
    <h4>{{=T("Overview")}}</h4>
    <p>{{=T.M("Number of entries: **%s**", total['entries'])}}</p>
    {{if total['entries'] > 0:}}
    <p>{{=T.M("Hit Ratio: **%(ratio)s%%** (**%(hits)s** %%{hit(hits)} and **%(misses)s** %%{miss(misses)})",
             dict( ratio=total['ratio'], hits=total['hits'], misses=total['misses']))}}
    </p>
    <p>
      {{=T("Size of cache:")}}
      {{if object_stats:}}
        {{=T.M("**%(items)s** %%{item(items)}, **%(bytes)s** %%{byte(bytes)}", dict(items=total['objects'], bytes=total['bytes']))}}
        {{if total['bytes'] > 524287:}}
          {{=T.M("(**%.0d MB**)", total['bytes'] / 1048576)}}
        {{pass}}
      {{else:}}
        {{=T.M("**not available** (requires the Python [[guppy http://pypi.python.org/pypi/guppy/ popup]] library)")}}
      {{pass}}
    </p>
    <p>
      {{=T.M("Cache contains items up to **%(hours)02d** %%{hour(hours)} **%(min)02d** %%{minute(min)} **%(sec)02d** %%{second(sec)} old.",
              dict(hours=total['oldest'][0], min=total['oldest'][1], sec=total['oldest'][2]))}}
    </p>
    {{=BUTTON(T('Cache Keys'), _onclick='jQuery("#all_keys").toggle().toggleClass( "w2p_hidden" );')}}
    <div class="w2p_hidden" id="all_keys">
      {{=total['keys']}}
    </div>
    <br />
    {{pass}}

    <h4>{{=T("RAM")}}</h4>
    <p>{{=T.M("Number of entries: **%s**", ram['entries'])}}</p>
    {{if ram['entries'] > 0:}}
    <p>{{=T.M("Hit Ratio: **%(ratio)s%%** (**%(hits)s** %%{hit(hits)} and **%(misses)s** %%{miss(misses)})",
             dict( ratio=ram['ratio'], hits=ram['hits'], misses=ram['misses']))}}
    </p>
    <p>
      {{=T("Size of cache:")}}
      {{if object_stats:}}
        {{=T.M("**%(items)s** items, **%(bytes)s** %%{byte(bytes)}", dict(items=ram['objects'], bytes=ram['bytes']))}}
        {{if ram['bytes'] > 524287:}}
          {{=T.M("(**%.0d MB**)", ram['bytes'] / 10485576)}}
        {{pass}}
      {{else:}}
        {{=T.M("``**not available**``:red (requires the Python [[guppy http://pypi.python.org/pypi/guppy/ popup]] library)")}}
      {{pass}}
    </p>
    <p>
      {{=T.M("RAM contains items up to **%(hours)02d** %%{hour(hours)} **%(min)02d** %%{minute(min)} **%(sec)02d** %%{second(sec)} old.",
              dict(hours=ram['oldest'][0], min=ram['oldest'][1], sec=ram['oldest'][2]))}}
    </p>
    {{=BUTTON(T('RAM Cache Keys'), _onclick='jQuery("#ram_keys").toggle().toggleClass( "w2p_hidden" );')}}
    <div class="w2p_hidden" id="ram_keys">
      {{=ram['keys']}}
    </div>
    <br />
    {{pass}}

    <h4>{{=T("DISK")}}</h4>
    <p>{{=T.M("Number of entries: **%s**", disk['entries'])}}</p>
    {{if disk['entries'] > 0:}}
      <p>
      {{=T.M("Hit Ratio: **%(ratio)s%%** (**%(hits)s** %%{hit(hits)} and **%(misses)s** %%{miss(misses)})",
            dict(ratio=disk['ratio'], hits=disk['hits'], misses=disk['misses']))}}
      </p>
      <p>
      {{=T("Size of cache:")}}
      {{if object_stats:}}
        {{=T.M("**%(items)s** %%{item(items)}, **%(bytes)s** %%{byte(bytes)}", dict( items=disk['objects'], bytes=disk['bytes']))}}
        {{if disk['bytes'] > 524287:}}
          {{=T.M("(**%.0d MB**)", disk['bytes'] / 1048576)}}
        {{pass}}
      {{else:}}
        {{=T.M("``**not available**``:red (requires the Python [[guppy http://pypi.python.org/pypi/guppy/ popup]] library)")}}
      {{pass}}
      </p>
      <p>
      {{=T.M("DISK contains items up to **%(hours)02d** %%{hour(hours)} **%(min)02d** %%{minute(min)} **%(sec)02d** %%{second(sec)} old.",
                dict(hours=disk['oldest'][0], min=disk['oldest'][1], sec=disk['oldest'][2]))}}
      </p>
      {{=BUTTON(T('Disk Cache Keys'), _onclick='jQuery("#disk_keys").toggle().toggleClass( "w2p_hidden" );')}}
      <div class="w2p_hidden" id="disk_keys">
      {{=disk['keys']}}
      </div>
      <br />
    {{pass}}
  </div>

  <div class="list-header">
    <h3>{{=T("Manage Cache")}}</h3>
  </div>

  <div class="content">
    <p>
      {{=form}}
    </p>
  </div>
</div>
<div class="clear"></div>
{{pass}}

{{if request.function=='graph_model':}}
<h2>{{=T("Graph Model")}}</h2>
  {{if not pgv:}}
    {{=T('pygraphviz library not found')}}
  {{elif not databases:}}
    {{=T("No databases in this application")}}
  {{else:}}	   
    <div class="btn-group">
      <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
        <i class="icon-download"></i> {{=T('Save model as...')}}
        <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
          <li><a href="{{=URL('appadmin', 'bg_graph_model', args=['png'])}}">png</a></li>
          <li><a href="{{=URL('appadmin', 'bg_graph_model', args=['svg'])}}">svg</a></li>
          <li><a href="{{=URL('appadmin', 'bg_graph_model', args=['pdf'])}}">pdf</a></li>
          <li><a href="{{=URL('appadmin', 'bg_graph_model', args=['ps'])}}">ps</a></li>
          <li><a href="{{=URL('appadmin', 'bg_graph_model', args=['dot'])}}">dot</a></li>
      </ul>
    </div>
    <br />
    {{=IMG(_src=URL('appadmin', 'bg_graph_model'))}}
  {{pass}}
{{pass}}

{{if request.function=='d3_graph_model':}}
<h2>{{=T("d3 Graph Model")}}</h2>
  {{#  Check if d3 is present ?}}
<div id="vis">
</div>

<style>
    .node {fill: steelblue;
           stroke: #636363;
           stroke-width: 1px;}

    .auth {fill: lightgrey;}

    .table {r: 10;}

    .link {stroke: #bbbbbb;
           stroke-width: 2px;}
    td {padding: 4px;}

    div.tooltip {
       position: absolute;
       text-align: left;
       /* width: 140px; */
       /*height: 28px;*/
       padding: 0px 5px 0px 5px;
       padding-top: 0px;
       font: 12px sans-serif;
       background: #fff7bc;  /* eeeeff; */
       border: solid 1px #aaa;
       border-radius: 6px;
       pointer-events: none;}

    h5 { font: 14px sans-serif;
         background : #ec7014; /* b24c; /* 111; */
         color: #ffffe5; /* white; */
         padding: 5px 2px 5px 2px;
         margin-top: 1px;}
    path {
           fill: #aaaaaa;}

</style>

<script>
    // HOw to get link ids instead of index
    // http://stackoverflow.com/questions/23986466/d3-force-layout-linking-nodes-by-name-instead-of-index

    // embedding web2py in d3
    // http://stackoverflow.com/questions/34326343/embedding-d3-js-graph-in-a-web2py-bootstrap-page

    {{ from gluon.serializers import json }}
    var nodes = {{=XML(json(nodes))}}
    var links = {{=XML(json(links))}}
    var edges = [];

    links.forEach(function(e) {
        var sourceNode = nodes.filter(function(n) {
            return n.name === e.source;
        })[0],
            targetNode = nodes.filter(function(n) {
            return n.name === e.target;
        })[0];

        edges.push({
            source: sourceNode,
            target: targetNode,
            value: 1});

    });

    edges.forEach(function(e) {

        if (!e.source["linkcount"]) e.source["linkcount"] = 0;
        if (!e.target["linkcount"]) e.target["linkcount"] = 0;

        e.source["linkcount"]++;
        e.target["linkcount"]++;
    })

    var width = 960, height = 600;
    var svg = d3.select("#vis").append("svg")
            .attr("width", width)
            .attr("height", height);

    // updated for d3 v4.
    var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function(d) { return d.id; }))
            .force("charge", d3.forceManyBody().strength(strength))
            .force("center", d3.forceCenter(width / 2, height / 2));

// charge strength
function strength(d) { return -500/d["linkcount"] ; }
// link distance
function distance(d) { return (d.source["linkcount"] + d.target["linkcount"]) * 5 ; }
function strengthl(d) { return 0.2/(d.source["linkcount"] + d.target["linkcount"]) ; }

simulation
    .nodes(nodes)
    .on("tick", tick);
    
simulation.force("link")
    .links(edges)
    .distance(distance)
    .strength(strengthl);

    // build the arrow.
   svg.append("svg:defs").selectAll("marker")
    .data(["end"])      // Different link/path types can be defined here
   .enter().append("svg:marker")    // This section adds in the arrows
    .attr("id", String)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 25)   /* Moves the arrow head out, allow for radius */
    .attr("refY", 0)   /* -1.5  */
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
    .append("svg:path")
    .attr("d", "M0,-5L10,0L0,5");

    var link = svg.selectAll('.link')
            .data(edges)
            .enter().append('line')
            .attr("class", "link")
            .attr("marker-end", "url(#end)");

    var node = svg.selectAll(".node")
            .data(nodes)
            .enter().append("g")
            .attr("class", function(d) { return "node " + d.type;})
            .attr("x", function(d) {return d.name.startsWith("auth") ? 0 : 960;})
            .classed("auth", function(d) { return (d.name.startsWith("auth") ? true : false);})
            .call(d3.drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended));;

    // add the nodes
    node.append('circle') /* 'circlej */
        .attr('r', 20)
        /* .attr('height', 25) */
        ;

    // add text
    node.append("text")
            .attr("x", 14)
            .attr("dy", "-1.2em")
            .text(function(d) {return d.name;});

    node.on("mouseover", function(d) {

        var g = d3.select(this);  // the node (table)

        // tooltip

         var fields = d.fields;
        fieldformat = "<TABLE>"
        fields.forEach(function(d) {
            fieldformat += "<TR><TD><B>"+ d.name+"</B></TD><TD>"+ d.type+"</TD><TD>"+ d.disp+"</TD></TR>";
        });
        fieldformat += "</TABLE>"

        // Define 'div' for tooltips
        var div = d3.select("body").append("div")  // declare the tooltip div
	        .attr("class", "tooltip")              // apply the 'tooltip' class
                .style("opacity", 0)
                .html('<h5>' + d.name + '</h5>' + fieldformat)
                .style("left", 10 + (d3.event.pageX) + "px")// or just (d.x + 50 + "px")
                .style("top", (d3.event.pageY - 20) + "px")// or ...
                .transition()
                .duration(800)
                .style("opacity", 0.9);
    });

    node.on("mouseout", function(d) {
        d3.select("body").select('div.tooltip').remove();
    });

// instead of waiting for force to end with :     force.on('end', function()
    // use .on("tick",  instead.  Here is the tick function
    function tick() {
        node.attr('transform', function(d) {
            return "translate(" + d.x + "," + d.y + ")"; });

        link.attr('x1', function(d) {return d.source.x;})
                .attr('y1', function(d) {return d.source.y;})
                .attr('x2', function(d) {return d.target.x;})
                .attr('y2', function(d) {return d.target.y;});
    };

        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
</script>
{{pass}}

{{if request.function == 'manage':}}
<h2>{{=heading}}</h2>
<ul class="nav nav-tabs">
  {{for k, tablename in enumerate(tablenames):}}
  <li{{=XML(' class="active"') if k == 0 else ''}}>
    <a href="#table-{{=tablename}}" data-toggle="tab">{{=labels[k]}}</a>
  </li>
  {{pass}}
</ul>

<div class="tab-content">
  {{for k, tablename in enumerate(tablenames):}}
  <div class="tab-pane{{=XML(' active') if k == 0 else ''}}" id="table-{{=tablename}}">
    {{=LOAD(f='manage.load', args=[request.args(0), k], ajax=True)}}
  </div>
  {{pass}}
</div>
{{pass}}
